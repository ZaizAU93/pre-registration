<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>Профиль пользователя</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f4f4;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header {
      background-color: #28a745;
      color: white;
      padding: 15px;
      text-align: center;
    }

    .main-container {
      flex: 1;
      display: flex;
      padding: 20px;
      gap: 20px;
    }

    .profile-section,
    .ticket-section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .profile-section {
      width: 250px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    input[type="text"],
    select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }

    .location-tree {
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 15px;
      margin: 15px 0;
      max-height: 300px;
      overflow-y: auto;
    }

    button {
      background-color: #28a745;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s;
    }

    button:hover {
      background-color: #218838;
    }

    footer {
      background-color: #28a745;
      color: white;
      text-align: center;
      padding: 10px;
      width: 100%;
    }


    .ticketTable {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .ticket {
      background: #e9ecef;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 1px 5px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .ticket h3 {
      margin: 0 0 5px 0;
      font-size: 1.2em;
      color: #333;
    }

    .ticket p {
      margin: 5px 0;
      color: #555;
    }

    .ticket .status {
      position: absolute;
      top: 15px;
      right: 15px;
      font-weight: bold;
      color: #28a745; /* Зеленый цвет для статуса */
    }

    .ticket .date {
      font-size: 0.9em;
      color: #888;
    }

    .no-tickets {
      text-align: center;
      color: #888;
      font-size: 1.2em;
      margin-top: 20px;
    }
  </style>


<script>

  const currentUserId = '[[${currentUserId}]]';

  function connect() {
    const socket = new SockJS('/ws');
    stompClient = Stomp.over(socket);

    stompClient.connect({}, function(frame) {
      console.log('Connected: ' + frame);

      stompClient.subscribe('/user/queue/messages', function(message) {
        const messageData = JSON.parse(message.body);
        displayMessage(messageData);

        // Уведомление
        if (messageData.senderType === 'ADMIN') {
          toastr.info('Новое сообщение от администратора: ' + messageData.content);
        }
      });

      stompClient.subscribe('/user/queue/notification/task/' + currentUserId, function (notification) {
        const notif = JSON.parse(notification.body);
        displayNotifications(notif, notif.sender.id);
      });

    });
  }



  function displayNotifications(message, userId) {
    console.log('Отображение уведомления:', message);
    const notificationElement = document.createElement('div');

    // Устанавливаем текст уведомления
    notificationElement.textContent = message.content;

    // Добавляем стили
    notificationElement.style.position = 'fixed';
    notificationElement.style.left = '20px'; // Размещаем уведомление слева
    notificationElement.style.bottom = '20px'; // Размещаем уведомление снизу
    notificationElement.style.padding = '15px';
    notificationElement.style.backgroundColor = 'rgba(0, 0, 0, 0.5)'; // Полупрозрачный черный фон
    notificationElement.style.color = 'white';
    notificationElement.style.borderRadius = '5px';
    notificationElement.style.zIndex = '1000'; // Чтобы уведомление было поверх других элементов
    notificationElement.style.boxShadow = '0 2px 10px rgba(0, 0, 0, 0.5)';
    notificationElement.style.marginBottom = '10px'; // Добавляем отступ между уведомлениями

    // Обработчик события клика
    notificationElement.addEventListener('click', () => {
      openAdminChat(userId); // Замените на вашу логику маршрутизации
    });

    // Добавляем уведомление в тело документа
    document.body.appendChild(notificationElement);
  }

  function updateTicketList(ticketData) {
    // Находим элемент тикета по ID
    const ticketElement = document.getElementById('tik' + ticketData.id);

    if (ticketElement) {
      // Обновляем статус
      const statusElement = ticketElement.querySelector('.status');
      const dateElement = ticketElement.querySelector('.date');

      statusElement.innerText = ticketData.status;
      dateElement.innerText = ticketData.createdAt; // Обновляем дату, если необходимо

      // Проверяем статус и добавляем кнопку, если статус IN_PROGRESS
      const existingButton = ticketElement.querySelector('.send-message-button');
      if (ticketData.status === 'IN_PROGRESS') {
        if (!existingButton) {
          const button = document.createElement('button');
          button.type = 'button';
          button.className = 'send-message-button';
          button.innerText = 'Отправить сообщение системотехнику';
          button.onclick = function () { sendMessage(ticketData.adminId, ticketData.user.id); };
          ticketElement.appendChild(button);
        }
      } else {
        // Удаляем кнопку, если статус не IN_PROGRESS
        if (existingButton) {
          existingButton.remove();
        }
      }
    }
  }

  // Функция для загрузки тикетов может остаться такой же
  function loadTickets() {
    fetch('/account/ticket/status')
            .then(response => {
              if (!response.ok) {
                throw new Error('Ошибка сети: ' + response.status);
              }
              return response.json();
            })
            .then(tickets => {
              tickets.forEach(ticket => {
                updateTicketList(ticket);
              });
            })
            .catch(error => console.error('Ошибка при загрузке тикетов:', error));
  }

  window.onload = function() {
    connect();
    loadTickets(); // Загрузка тикетов при загрузке страницы
  }

</script>

</head>
<body>

<header>
  <h1>Профиль пользователя</h1>
</header>

<div class="main-container">
  <!-- Профиль пользователя -->
  <div class="profile-section">
    <div class="avatar-picker">
      <img src="avatar1.png" alt="Аватар" class="avatar" style="width: 100px; height: 100px; border-radius: 50%;">
    </div>

    <h2>Информация</h2>
    <div class="admin-info">
      <p><strong>Имя:</strong> <span th:text="${user.surname + ' ' + user.name + ' ' + user.fathername}"></span></p>
      <p><strong>Должность:</strong> <span th:text="${job.name}"></span></p>
      <p><strong>Телефон:</strong> <span th:text="${user.workPhone}"></span></p>
    </div>

    <a href="/tickets" style="display: block; margin-top: 20px; color: #28a745;">← Назад к списку</a>
  </div>

  <!-- Форма создания тикета -->
  <div class="ticket-section">
    <h1>Создать новый тикет</h1>

    <form th:action="@{/tickets/create}" th:object="${ticket}" method="post" onsubmit="return validateForm()">
      <!-- Скрытое поле для местоположения -->
      <input type="hidden" id="selectedLocation" name="locationId" required>
      <input type="hidden" id="selectedLocationText" name="locationText" required>

      <div class="form-group">
        <label for="description">Описание:</label>
        <input type="text" id="description" th:field="*{description}" required>
      </div>

      <div class="form-group">
        <label for="problem">Проблема:</label>
        <select id="problem" th:field="*{problems}" required>
          <option value="" disabled selected>Выберите проблему</option>
          <option th:each="problem : ${problems}"
                  th:value="${problem.id}"
                  th:text="${problem.topic}"></option>
        </select>
      </div>

      <div class="form-group">
        <label>Выберите местоположение:</label>
        <div class="location-tree" id="locationTree"></div>
      </div>

      <button type="submit">Создать тикет</button>
    </form>

  </div>
  <div class="ticket-section">
    <h1>Оставленные заявки:</h1>
    <div th:if="${!#lists.isEmpty(tiket_users)}" class="ticketTable">
      <div th:each="ticket : ${tiket_users}" class="ticket" th:id="'tik' + ${ticket.id}">
        <h3 th:text="${ticket.description}">Описание заявки</h3>
        <p class="status" th:text="${ticket.status}">Статус</p>
        <p class="date" th:text="${ticket.createdAt}">Дата создания</p>
        <p th:text="${ticket.problems}">Проблема</p>

      </div>
    </div>
    <div th:if="${#lists.isEmpty(tiket_users)}" class="no-tickets">
      <p>Нет оставленных заявок.</p>
    </div>
  </div>

  </div>
</div>




<footer>
  <p>&copy; 2025 Все права защищены</p>
</footer>

<script>
// модальное окно отчета
  let currentTaskId = null;

  function openReportModal(taskId) {
    currentTaskId = taskId; // Сохраняем ID текущей задачи
    document.getElementById('reportModal').style.display = 'block';
  }

  function closeReportModal() {
    document.getElementById('reportModal').style.display = 'none';
  }

  function submitReport() {
    const reportText = document.getElementById('reportText').value;

    if (!reportText) {
      alert('Пожалуйста, введите текст отчета.');
      return;
    }

    const report = {
      taskId: currentTaskId,
      content: reportText
    };

    $.ajax({
      type: "POST",
      url: "/report",
      contentType: "application/json",
      data: JSON.stringify(report),
      success: function(response) {
        alert(response); // Выводим сообщение от сервера
        closeReportModal(); // Закрываем модальное окно

        // Убираем задачу из списка "В работе"
        const taskRow = document.querySelector(`tr[data-task-id="${currentTaskId}"]`);
        if (taskRow) {
          taskRow.remove();
        }

        // Обновляем счетчики задач
        updateTaskCounters();
      },
      error: function(xhr, status, error) {
        console.error("Ошибка при сохранении отчета:", xhr.responseText);
        alert('Произошла ошибка при сохранении отчета. Пожалуйста, попробуйте еще раз.');
      }
    });
  }

// --- модальное окно

$(document).ready(function () {
  const tree = $('#locationTree').jstree({
    'core': {
      'data': {
        'url': '/locations/tree',
        'dataType': 'json',
        'data': function (node) {
          return { 'id': node.id };
        }
      }
    },
    'plugins': ['types', 'wholerow']
  });

  tree.on('changed.jstree', function (e, data) {
    const selectedNode = data.instance.get_node(data.selected[0]);
    $('#selectedLocation').val(selectedNode.id); // ID местоположения
    $('#selectedLocationText').val(getFullPath(selectedNode)); // Полный путь местоположения
    console.log('Выбрано местоположение:', selectedNode.id, getFullPath(selectedNode));
  });
});

// Функция для получения полного пути
function getFullPath(node) {
  let path = [];
  let current = node;

  while (current) {
    path.unshift(current.text); // Добавляем название текущего узла в начало массива
    current = current.parent ? $('#locationTree').jstree().get_node(current.parent) : null; // Получаем родительский узел
  }

  return path.join(', '); // Возвращаем полный путь, разделённый слэшами
}

function sendMessage(adminId, sender) { window.location.href = '/chat/user?adminId=' + adminId + '&sender=' + sender; }

function validateForm() {
  const selectedLocation = document.getElementById('selectedLocation').value;
  if (!selectedLocation) {
    alert('Пожалуйста, выберите местоположение.');
    return false; // Предотвращаем отправку формы
  }
  return true; // Разрешаем отправку формы
}

</script>
</body>
</html>
