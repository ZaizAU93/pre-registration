<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>Чат с администратором</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
  <style>
    /* Обновленные стили для лучшего отображения */
    .messages {
      height: 400px;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 10px;
      margin-bottom: 10px;
      background: #f9f9f9;
    }

    .message {
      margin: 8px 0;
      padding: 8px;
      border-radius: 4px;
      max-width: 70%;
    }

    .message.user {
      background: #e3f2fd;
      margin-left: auto;
    }

    .message.admin {
      background: #f5f5f5;
      margin-right: auto;
    }

    .form-group {
      display: flex;
      gap: 10px;
    }

    input[type="text"] {
      flex: 1;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
  </style>

  <script>
    let stompClient;
    let adminId;
    let senderId;

    function connect() {
      // Получаем параметры из URL
      const urlParams = new URLSearchParams(window.location.search);
      adminId = urlParams.get('adminId');
      senderId = urlParams.get('sender');

      const socket = new SockJS('/ws');
      stompClient = Stomp.over(socket);

      stompClient.connect({}, function(frame) {
        console.log('Connected: ' + frame);

        // Подписка на персональную очередь
        stompClient.subscribe(`/user/queue/messages`, function(message) {
          const messageData = JSON.parse(message.body);
          displayMessage(messageData);
        });

        // Загрузка истории сообщений
        loadMessageHistory();
      });
    }

    function displayMessage(message) {
      const messagesContainer = document.getElementById('messages');
      const messageElement = document.createElement('div');

      messageElement.className = `message ${message.senderType === 'ADMIN' ? 'admin' : 'user'}`;
      messageElement.innerHTML = `
        <div class="message-header">${message.senderType === 'ADMIN' ? 'Админ' : 'Вы'}</div>
        <div class="message-content">${message.content}</div>
        <div class="message-time">${new Date().toLocaleTimeString()}</div>
      `;

      messagesContainer.appendChild(messageElement);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function sendMessage() {
      const messageInput = document.getElementById('messageInput');
      const content = messageInput.value.trim();

      if (content) {
        const message = {
          content: content,
          senderId: senderId,
          recipientId: adminId,
          senderType: 'USER'
        };

        stompClient.send('/app/chat', {}, JSON.stringify(message));
        messageInput.value = '';
      }
    }

    function loadMessageHistory() {
      fetch(`/api/messages?recipientId=${adminId}&senderId=${senderId}`)
              .then(response => response.json())
              .then(messages => {
                messages.forEach(msg => displayMessage(msg));
              });
    }

    // Обработка нажатия Enter
    document.getElementById('messageInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });

    window.onload = connect;
  </script>
</head>
<body>
<header>
  <h1>Чат с администратором</h1>
</header>

<div class="main-container">
  <div class="chat-section">
    <div class="messages" id="messages"></div>
    <div class="form-group">
      <input type="text" id="messageInput" placeholder="Введите сообщение...">
      <button onclick="sendMessage()">Отправить</button>
    </div>
  </div>
</div>
</body>
</html>